#!/bin/bash

# Combined Pre-push hook: API-Genie validation first, then Secret-Genie (with UI/justification, diff only)
# 1. Run API-Genie validation if API repo
# 2. If passed, run Secret-Genie secretscan.py --range <range> (UI, justification, HTML report, diff only)
# 3. Block push if either fails

set -e

HOOK_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
GENIE_ROOT="$(dirname "$HOOK_DIR")"
REPO_ROOT="$(pwd)"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Dynamic Python detection
if command -v python3 &> /dev/null; then
    PYTHON=python3
elif command -v python &> /dev/null; then
    PYTHON=python
else
    echo -e "${RED}Error: Python is not installed or not in PATH${NC}"
    exit 1
fi

# Get commit range for push
range=""
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        range="$local_sha"
    else
        range="$remote_sha..$local_sha"
    fi
    break
done

# API-Genie validation (only for API repos)
if [ -f "$GENIE_ROOT/validation/api_validator.py" ]; then
    API_TYPE=$($PYTHON -m validation.api_validator --identify-only --repo-path "$REPO_ROOT" 2>/dev/null | grep "API Type:" | cut -d' ' -f3 || echo "")
    if [ "$API_TYPE" = "PCF" ] || [ "$API_TYPE" = "SHP" ] || [ "$API_TYPE" = "IKP" ] || [ "$API_TYPE" = "SHP/IKP" ]; then
        echo -e "${BLUE}Detected API project ($API_TYPE). Running API-Genie validation...${NC}"
        if [ -n "$range" ]; then
            CHANGED_FILES=$(git diff --name-only "$range" 2>/dev/null || echo "")
            if [ -n "$CHANGED_FILES" ]; then
                echo -e "${YELLOW}Validating changes in range: $range${NC}"
                cd "$GENIE_ROOT"
                if $PYTHON -m validation.api_validator --commit-range="$range" --repo-path "$REPO_ROOT"; then
                    echo -e "${GREEN}✓ API-Genie validation passed${NC}"
                else
                    echo -e "${RED}✗ API-Genie validation failed. Push blocked.${NC}"
                    exit 1
                fi
            else
                echo -e "${YELLOW}No file changes detected in push range${NC}"
            fi
        fi
    else
        echo -e "${YELLOW}Not an API project (detected: ${API_TYPE:-unknown}), skipping API validation.${NC}"
    fi
else
    echo -e "${YELLOW}API-Genie validation module not found, skipping API validation.${NC}"
fi

# After API validation, run Secret-Genie scan for the commit range
if [ -n "$range" ]; then
    echo -e "${BLUE}Running Secret-Genie secret scan (with UI/justification, staged changes)...${NC}"
    cd "$REPO_ROOT"
    $PYTHON "$GENIE_ROOT/secret-genie/commit_scripts/pre_push_secret_scan.py"
    SECRET_EXIT_CODE=$?
else
    echo -e "${YELLOW}No commit range detected for secret scan. Skipping.${NC}"
    SECRET_EXIT_CODE=0
fi

if [ $SECRET_EXIT_CODE -ne 0 ]; then
    echo -e "${RED}✗ Secret-Genie scan failed or was aborted. Push blocked.${NC}"
    exit 1
else
    echo -e "${GREEN}✓ Secret-Genie scan passed or justified. Push allowed.${NC}"
fi

exit 0 